<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ATLAS Corporation | Game Archive</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Extended Tailwind Configuration for ATLAS Corp branding
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'atlas-dark': '#0d1a26',
                        'atlas-blue': '#2b6cb0', /* Tailwind blue-700 equivalent */
                        'atlas-light': '#a5b4fc', /* For button highlights */
                        'status-complete': '#10b981', /* Green */
                        'status-progress': '#f59e0b', /* Yellow */
                        'status-pending': '#60a5fa',  /* Blue */
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        /* Set a custom font and background for a corporate look */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1a26; /* Dark Navy Background */
            padding-bottom: 4rem; /* Space for fixed footer */
        }
        /* Custom scrollbar for game results */
        .scrollable-results::-webkit-scrollbar {
            width: 8px;
        }
        .scrollable-results::-webkit-scrollbar-thumb {
            background-color: #2b6cb0; /* Bright blue for scroll thumb */
            border-radius: 4px;
        }
        .text-atlas-blue {
            color: #2b6cb0; /* Tailwind blue-700 equivalent */
        }
        .btn-base {
            @apply px-4 py-2 font-semibold rounded-lg text-white transition duration-200 shadow-md;
        }
        .btn-blue {
            @apply btn-base bg-atlas-blue hover:bg-blue-700;
        }
        .btn-green {
            @apply btn-base bg-green-600 hover:bg-green-700;
        }
        .input-style {
            @apply p-3 text-lg rounded-lg border-2 border-gray-600 bg-gray-700 text-white focus:outline-none focus:border-atlas-blue transition w-full;
        }
    </style>
</head>
<body class="min-h-screen p-4 sm:p-8">

    <!-- Notification Area for API status messages -->
    <div id="notification-area" class="fixed top-0 left-0 right-0 z-50 p-4 space-y-2"></div>

    <div class="max-w-4xl mx-auto bg-gray-800 shadow-2xl rounded-xl p-6 md:p-10">
        <!-- Header -->
        <header class="text-center mb-6 border-b border-gray-700 pb-4">
            <h1 class="text-4xl md:text-5xl font-extrabold text-white tracking-tight">
                ATLAS <span class="text-atlas-blue">Corporation</span>
            </h1>
            <p class="mt-2 text-xl text-gray-400">Official Game Archive</p>
        </header>
        
        <!-- Main View Tabs -->
        <div class="flex justify-center space-x-4 mb-8">
            <button 
                id="tab-archive" 
                class="btn-base bg-atlas-light text-atlas-dark hover:bg-gray-400" 
                onclick="setView('archive')"
            >
                Archive View
            </button>
            <button 
                id="tab-admin" 
                class="btn-base bg-gray-600 hover:bg-atlas-blue" 
                onclick="setView('admin')"
            >
                Admin Portal
            </button>
        </div>

        <!-- Archive View Content -->
        <div id="view-archive" class="space-y-8">
            <!-- Date Picker Section -->
            <div class="flex flex-col sm:flex-row items-center justify-center space-y-4 sm:space-y-0 sm:space-x-6">
                <label for="gameDate" class="text-lg font-medium text-gray-300">
                    Select Game Date:
                </label>
                <input 
                    type="date" 
                    id="gameDate" 
                    class="input-style w-full sm:w-auto text-lg"
                >
                <button 
                    id="viewGameBtn" 
                    class="w-full sm:w-auto px-6 py-3 text-lg font-semibold rounded-lg text-white bg-atlas-blue hover:bg-blue-700 transition duration-300 shadow-md hover:shadow-lg transform hover:scale-[1.02] disabled:opacity-50"
                    onclick="showGame()"
                    disabled 
                >
                    View Game
                </button>
            </div>


            <!-- Game Results Display Area -->
            <section class="mt-8">
                <h2 class="text-2xl font-bold text-gray-300 mb-4 border-b border-gray-700 pb-2">Match Report</h2>
                <div id="game-results" class="bg-gray-700 p-4 rounded-lg min-h-[250px] max-h-[500px] overflow-y-auto scrollable-results">
                    <p id="initial-message" class="text-gray-400 text-center py-16">
                        Loading ATLAS Corporation archive data...
                    </p>
                </div>
            </section>
        </div>
        
        <!-- Admin Portal Content -->
        <div id="view-admin" class="space-y-8 hidden">
             <div id="auth-check" class="bg-red-900 p-4 rounded-lg text-red-300 text-center font-bold">
                <p>Authentication Required for Admin Access.</p>
            </div>
            
            <!-- Admin Login Form -->
            <div class="bg-gray-700 p-6 rounded-xl shadow-lg space-y-4">
                <h2 class="text-2xl font-bold text-atlas-blue border-b border-gray-600 pb-2">Admin Login</h2>
                <input type="text" id="adminUsername" class="input-style" placeholder="Username">
                <input type="password" id="adminPassword" class="input-style" placeholder="Password">
                <button class="btn-blue w-full py-3" onclick="adminLogin()">Login</button>
            </div>
            
            <!-- Create/Save Game Record Form (Visible only after login) -->
            <div id="admin-controls" class="hidden bg-gray-700 p-6 rounded-xl shadow-lg space-y-4">
                <h2 class="text-2xl font-bold text-atlas-blue border-b border-gray-600 pb-2">Create New Game Record</h2>
                
                <div class="flex space-x-4">
                    <div class="w-1/2">
                        <label for="adminDate" class="block text-sm font-medium text-gray-300 mb-1">Game Date</label>
                        <input type="date" id="adminDate" class="input-style text-lg" value="">
                    </div>
                    <div class="w-1/2">
                        <label for="adminStatus" class="block text-sm font-medium text-gray-300 mb-1">Game Status</label>
                        <select id="adminStatus" class="input-style text-lg h-[50px] bg-gray-700">
                            <option value="COMPLETE">COMPLETE</option>
                            <option value="IN_PROGRESS">IN_PROGRESS</option>
                            <option value="PENDING">PENDING</option>
                        </select>
                    </div>
                </div>
                
                <div>
                    <label for="adminEntries" class="block text-sm font-medium text-gray-300 mb-1">Game Entries (One per line, e.g., Tokyo (ABHIK))</label>
                    <textarea 
                        id="adminEntries" 
                        class="input-style h-48 resize-none" 
                        placeholder="New York (SWAY)&#10;Paris (DHN)&#10;&#10;-- To Delete Record, clear all text and Save. --"
                    ></textarea>
                </div>

                <button class="btn-green w-full py-3" onclick="parseAndSaveGame()">Save & Update Archive</button>
            </div>
        </div>


        <!-- Footer / Instructions -->
        <footer class="mt-10 pt-4 border-t border-gray-700 text-center text-sm text-gray-500">
            <p>ATLAS Corporation | From Abhishek, Swayam, Dhyan, Darsh</p>
            <p class="mt-1">Lead Developer: Abhishek</p>
        </footer>
    </div>


    <script>
        // =========================================================================
        // !!! PASTE YOUR VALIDATED CREDENTIALS HERE !!!
        // This is the only part you need to edit to auto-load your data.
        // =========================================================================
        const HARDCODED_URL = "https://api.jsonbin.io/v3/b/68f3dc64d0ea881f40aa8741"; 
        const HARDCODED_KEY = "$2a$10$zqLmCEPiBb8GMRjxY1ATEupOlfjxD1zAqFEeyC/ZZwuon0o0t1Ip2"; 
        // =========================================================================
        
        const ADMIN_USER = 'atlasadmin'; // Default Admin Username
        const ADMIN_PASS = 'gamecorp';   // Default Admin Password

        let ATLAS_ARCHIVE = null; // Variable to hold the fetched JSON data (an array of games)
        let isAuthenticated = false;

        // --- Utility Functions ---

        // Display transient notification messages
        function showNotification(message, type = 'success') {
            const area = document.getElementById('notification-area');
            const color = type === 'success' ? 'bg-green-600' : type === 'error' ? 'bg-red-600' : type === 'info' ? 'bg-blue-600' : 'bg-yellow-600';
            const notification = document.createElement('div');
            notification.className = `p-3 rounded-lg text-white font-semibold shadow-xl ${color} max-w-xs mx-auto transform transition duration-300`;
            notification.innerHTML = message;
            area.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.add('opacity-0');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Converts YYYY-MM-DD (from input) to DD/MM/YYYY (for comparison/display)
        function convertDateToDDMMYYYY(dateString) {
            if (!dateString) return null;
            const parts = dateString.split('-'); // e.g., ["2025", "10", "15"]
            return `${parts[2]}/${parts[1]}/${parts[0]}`;
        }

        // Gets Tailwind classes for status colors
        function getStatusClasses(status) {
            switch (status) {
                case 'COMPLETE':
                    return 'bg-status-complete text-gray-800';
                case 'IN_PROGRESS':
                    return 'bg-status-progress text-gray-800';
                case 'PENDING':
                    return 'bg-status-pending text-gray-800';
                default:
                    return 'bg-gray-600 text-white';
            }
        }
        
        // --- Tab View Control ---
        function setView(viewId) {
            document.getElementById('tab-archive').classList.remove('bg-atlas-light', 'text-atlas-dark');
            document.getElementById('tab-archive').classList.add('bg-gray-600', 'hover:bg-atlas-blue');
            document.getElementById('tab-admin').classList.remove('bg-atlas-light', 'text-atlas-dark');
            document.getElementById('tab-admin').classList.add('bg-gray-600', 'hover:bg-atlas-blue');

            document.getElementById('view-archive').classList.add('hidden');
            document.getElementById('view-admin').classList.add('hidden');

            document.getElementById(`tab-${viewId}`).classList.remove('bg-gray-600', 'hover:bg-atlas-blue');
            document.getElementById(`tab-${viewId}`).classList.add('bg-atlas-light', 'text-atlas-dark');
            document.getElementById(`view-${viewId}`).classList.remove('hidden');
        }

        // --- Admin/Authentication ---

        function adminLogin() {
            const user = document.getElementById('adminUsername').value;
            const pass = document.getElementById('adminPassword').value;

            if (user === ADMIN_USER && pass === ADMIN_PASS) {
                isAuthenticated = true;
                document.getElementById('auth-check').classList.add('hidden');
                document.getElementById('admin-controls').classList.remove('hidden');
                showNotification('Admin Logged In', 'success');
            } else {
                showNotification('Invalid Credentials', 'error');
            }
        }

        // --- API & Data Functions ---

        async function loadArchiveData() {
            const resultsDiv = document.getElementById('game-results');
            const viewBtn = document.getElementById('viewGameBtn');
            const initialMessage = document.getElementById('initial-message');

            if (viewBtn) viewBtn.disabled = true;
            if (initialMessage) initialMessage.classList.add('animate-pulse');

            const url = HARDCODED_URL;
            const key = HARDCODED_KEY;

            if (url === "YOUR_BIN_ID_URL_HERE" || key === "YOUR_MASTER_KEY_HERE" || !url.startsWith('https://')) {
                 if (resultsDiv) {
                     resultsDiv.innerHTML = `
                        <div class="text-center py-12">
                            <p class="text-xl font-bold text-red-500 mb-2">Configuration Required!</p>
                            <p class="text-gray-300">Please provide your valid <code>HARDCODED_URL</code> and <code>HARDCODED_KEY</code> in the script block.</p>
                        </div>`;
                 }
                return;
            }

            try {
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'X-Master-Key': key,
                        'X-Bin-Meta': 'false'
                    }
                });

                if (!response.ok) {
                    const errorDetails = `HTTP Error: ${response.status}. Check ID URL, Master Key, or if the Bin is Public.`;
                    throw new Error(errorDetails);
                }

                const data = await response.json();
                
                ATLAS_ARCHIVE = Array.isArray(data) ? data : [];
                
                if (initialMessage) {
                    initialMessage.textContent = "Archive loaded successfully. Select a date to view a match report.";
                    initialMessage.classList.remove('animate-pulse');
                }
                if (viewBtn) viewBtn.disabled = false;
                showNotification('Archive Loaded from JSONBin', 'success');
                
            } catch (error) {
                console.error("Failed to load game archive data. Details:", error);
                
                if (resultsDiv) {
                    resultsDiv.innerHTML = `
                        <div class="text-center py-12">
                            <p class="text-xl font-bold text-red-500 mb-2">Error Loading Archive!</p>
                            <p class="text-gray-300">Could not connect to JSONBin.</p>
                            <p class="text-xs text-gray-500 mt-1">Error Details: ${error.message}</p>
                            <p class="text-xs text-gray-400 mt-4">Check console (F12) for detailed network information.</p>
                        </div>`;
                }
                showNotification('Data Load Failed', 'error');
            }
        }

        async function saveGameArchive() {
            const url = HARDCODED_URL;
            const key = HARDCODED_KEY;

             try {
                const payload = JSON.stringify(ATLAS_ARCHIVE);

                const response = await fetch(url, {
                    method: 'PUT', // PUT overwrites the entire Bin
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': key,
                        'X-Bin-Meta': 'false'
                    },
                    body: payload
                });

                if (!response.ok) {
                    const errorDetails = `HTTP Save Error: ${response.status}. Failed to overwrite Bin.`;
                    throw new Error(errorDetails);
                }

                // Reload the data back immediately to confirm and update the global state
                await loadArchiveData(); 
                showNotification('Archive successfully synced to JSONBin!', 'success');

            } catch (error) {
                console.error("Data Save Error:", error);
                showNotification(`SAVE FAILED: ${error.message}`, 'error');
            }
        }

        // --- Core Logic for Saving/Deleting/Appending Records ---
        function parseAndSaveGame() {
            if (!isAuthenticated) {
                showNotification('Must be logged into Admin Portal to save.', 'error');
                return;
            }

            const date = document.getElementById('adminDate').value;
            const status = document.getElementById('adminStatus').value;
            const entriesText = document.getElementById('adminEntries').value;
            
            if (!date) {
                showNotification('Date cannot be blank.', 'error');
                return;
            }

            // 1. Parse Entries (only keeps lines with content)
            const newEntries = entriesText.split('\n')
                .map(line => line.trim())
                .filter(line => line.length > 0)
                .map((line, index) => {
                    // Regex is flexible to allow any number of characters inside the parentheses
                    const match = line.match(/(.*?)\s*\(([^)]+)\)/);
                    if (match) {
                        return { entry: match[1].trim(), player: match[2].trim() };
                    } else {
                        // If no player is specified, assign a generic ID
                        return { entry: line, player: `Unknown${index + 1}` }; 
                    }
                });
            
            const formattedDate = convertDateToDDMMYYYY(date);

            if (!ATLAS_ARCHIVE) {
                ATLAS_ARCHIVE = [];
            }

            // 2. Check for existing game index
            const existingIndex = ATLAS_ARCHIVE.findIndex(game => game.date === formattedDate);

            // --- DELETION LOGIC (If entries are blank, delete the record) ---
            if (newEntries.length === 0) {
                if (existingIndex !== -1) {
                    ATLAS_ARCHIVE.splice(existingIndex, 1);
                    saveGameArchive();
                    showNotification(`Game record for ${formattedDate} successfully DELETED.`, 'warning');
                } else {
                    showNotification(`No existing record found for ${formattedDate} to delete.`, 'info');
                }
                return; 
            }
            // --- END DELETION LOGIC ---
            
            // 3. If entries are NOT empty, proceed with APPEND/ADD logic
            if (existingIndex !== -1) {
                // *** APPEND LOGIC (Update existing entries) ***
                
                const existingGame = ATLAS_ARCHIVE[existingIndex];
                
                // Concatenate the old entries with the new entries
                const updatedEntries = existingGame.entries.concat(newEntries);

                // Create the updated game object, keeping the original ID
                const updatedGame = {
                    ...existingGame, 
                    status: status, // Update status
                    entries: updatedEntries, // Use combined entries
                    savedAt: new Date().toISOString() // Update timestamp
                };
                
                ATLAS_ARCHIVE[existingIndex] = updatedGame; 
                
                showNotification(`Existing game record for ${formattedDate} was successfully updated with new entries.`, 'info');
            } else {
                // ADD NEW RECORD
                
                const newGame = {
                    id: `${formattedDate}-${ATLAS_ARCHIVE.length + 1}`,
                    date: formattedDate,
                    status: status,
                    entries: newEntries,
                    savedAt: new Date().toISOString()
                };

                ATLAS_ARCHIVE.push(newGame);
                showNotification(`New game record for ${formattedDate} created.`, 'success');
            }

            // 4. Trigger Save to JSONBin
            saveGameArchive();
        }
        // --- END OF CORE LOGIC ---


        // --- Core Logic Function to Display Games ---
        function showGame() {
            if (!ATLAS_ARCHIVE) return; // Safeguard if data isn't loaded

            const dateInput = document.getElementById('gameDate');
            const resultsDiv = document.getElementById('game-results');
            const dateValue = dateInput.value; // YYYY-MM-DD format

            if (!resultsDiv) return;

            resultsDiv.innerHTML = '';
            
            if (!dateValue) {
                resultsDiv.innerHTML = '<p class="text-red-400 text-center py-16">Please select a valid date to view the game.</p>';
                return;
            }

            // The data stored in the archive uses DD/MM/YYYY
            const searchDateDDMMYYYY = convertDateToDDMMYYYY(dateValue);

            // Filter all games that match the selected date (DD/MM/YYYY)
            const gamesForDate = ATLAS_ARCHIVE.filter(game => game.date === searchDateDDMMYYYY);

            if (gamesForDate.length === 0) {
                resultsDiv.innerHTML = `
                    <p class="text-gray-400 text-center py-16">
                        No official ATLAS Corporation games were recorded for <span class="font-bold text-white">${searchDateDDMMYYYY}</span>.
                    </p>`;
                return;
            }

            // Loop through all games found for the date and render them
            gamesForDate.forEach((game) => {
                const entries = game.entries;
                const status = game.status;
                const statusClasses = getStatusClasses(status);
                
                let entryHTML = '';

                // 1. Generate the list of entries
                if (entries.length > 0) {
                    entryHTML = `
                        <ul class="space-y-3 mt-4 px-1">
                            ${entries.map((item, entryIndex) => {
                                // Keeping styling consistent with your original intent
                                const neutralBorder = 'border-atlas-blue'; 
                                const neutralPlayerBg = 'bg-gray-600';
                                
                                return `
                                    <li class="p-3 bg-gray-800 rounded-lg shadow-md border-l-4 ${neutralBorder}">
                                        <div class="flex justify-between items-center">
                                            <!-- Entry Content with sequential number -->
                                            <span class="text-white text-lg font-semibold">
                                                ${entryIndex + 1}. ${item.entry}
                                            </span>
                                            
                                            <!-- Player Badge (Now supports up to 5 characters comfortably) -->
                                            <span class="text-xs font-bold min-w-[3rem] px-2 py-1 text-center rounded-full text-white ${neutralPlayerBg} shadow-inner flex-shrink-0">
                                                ${item.player}
                                            </span>
                                        </div>
                                    </li>
                                `;
                            }).join('')}
                        </ul>`;
                } else {
                     entryHTML = `<p class="text-gray-400 text-center py-2 text-sm">No entries have been recorded yet for this game.</p>`;
                }

                // 2. Generate the Game Card for this match
                const gameCard = `
                    <div class="bg-gray-700 p-4 rounded-lg shadow-xl mb-6">
                        <div class="flex justify-between items-start border-b border-gray-600 pb-2 mb-3">
                            <div>
                                <h3 class="font-extrabold text-white text-xl">Game Report: <span class="text-atlas-blue">${game.id}</span></h3>
                            </div>
                            <span class="text-sm text-gray-300 bg-gray-600 py-1 px-3 rounded-full">${game.date}</span>
                        </div>
                        
                        <p class="font-bold text-gray-300 text-lg border-b border-gray-700 pb-1 mb-2">Game Entries:</p>
                        
                        <!-- Entries List -->
                        ${entryHTML}
                        
                        <!-- Game Result Field (Visually separated at the bottom) -->
                        <div class="bg-gray-800 border-l-4 ${statusClasses} p-3 rounded-md mt-6 shadow-inner">
                            <p class="font-bold text-lg mb-1 ${status === 'COMPLETE' ? 'text-green-300' : status === 'IN_PROGRESS' ? 'text-yellow-300' : 'text-blue-300'}">Game Status:</p>
                            <p class="text-white text-md">${status}</p>
                        </div>
                    </div>`;

                resultsDiv.innerHTML += gameCard;
            });
        }


        // --- Initialization ---

        document.addEventListener('DOMContentLoaded', () => {
            // Set input default to today's date (YYYY-MM-DD format)
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('gameDate').value = today;
            document.getElementById('adminDate').value = today;
            
            // Start loading the data immediately
            loadArchiveData(); 
            
            // Set initial tab state
            setView('archive');
        });
    </script>
</body>
</html>

