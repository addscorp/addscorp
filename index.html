<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ATLAS Corporation Game Archive</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'atlas-dark': '#0d1a26',
                        'atlas-blue': '#1e40af',
                        'atlas-light': '#a5b4fc',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .container-mobile {
            max-width: 100%;
            padding: 0.5rem;
        }
        @media (min-width: 640px) {
            .container-mobile {
                max-width: 600px;
                padding: 1rem;
            }
        }
        .input-style {
            @apply p-2 rounded-lg border border-gray-600 bg-gray-700 text-white focus:outline-none focus:border-atlas-blue transition w-full;
        }
        .btn-base {
            @apply px-4 py-2 font-semibold rounded-lg text-white transition duration-200 shadow-md;
        }
        .btn-blue {
            @apply btn-base bg-atlas-blue hover:bg-blue-700;
        }
        .btn-green {
            @apply btn-base bg-green-600 hover:bg-green-700;
        }
        .btn-red {
            @apply btn-base bg-red-600 hover:bg-red-700;
        }
        .card {
            @apply bg-gray-800 p-4 rounded-xl shadow-lg;
        }
    </style>
</head>
<body class="bg-atlas-dark text-white min-h-screen">

    <!-- Notification Area -->
    <div id="notification-area" class="fixed top-0 left-0 right-0 z-50 p-4 space-y-2"></div>

    <div class="container-mobile mx-auto pt-6">
        <header class="text-center mb-6">
            <h1 class="text-4xl font-extrabold text-atlas-light">ATLAS CORPORATION</h1>
            <p id="subheading" class="text-gray-400 mt-1">Game Archive & Admin Portal</p>
        </header>

        <!-- Main View Tabs -->
        <div class="flex justify-center space-x-2 mb-6">
            <button id="tab-archive" class="btn-base" onclick="setView('archive')">Archive View</button>
            <button id="tab-admin" class="btn-base" onclick="setView('admin')">Admin Portal</button>
        </div>

        <!-- Connection Fields (Hidden if configured) -->
        <div id="config-panel" class="card mb-6 space-y-4">
            <h2 class="text-xl font-bold text-atlas-light">Connection Setup</h2>
            <div>
                <label for="binUrl" class="block text-sm font-medium text-gray-300 mb-1">JSONBin ID URL</label>
                <input type="url" id="binUrl" class="input-style" placeholder="https://api.jsonbin.io/v3/b/..." value="">
            </div>
            <div>
                <label for="masterKey" class="block text-sm font-medium text-gray-300 mb-1">JSONBin Master Key</label>
                <input type="password" id="masterKey" class="input-style" placeholder="Paste your Master Key here" value="">
            </div>
            <button id="loadDataBtn" class="btn-green w-full" onclick="initManualLoad()">Load Latest Data</button>
        </div>

        <!-- Archive View -->
        <div id="view-archive" class="space-y-4">
            <div class="card">
                <h2 class="text-xl font-bold text-atlas-light mb-3">Game Records</h2>
                <select id="gameSelector" class="input-style mb-3" onchange="displayGameDetails()">
                    <option value="">-- Select Game Date --</option>
                </select>
            </div>
            <div id="game-details" class="card hidden">
                <p id="detail-date" class="text-lg font-bold mb-2"></p>
                <p id="detail-status" class="mb-4 text-sm"></p>
                <ul id="entries-list" class="space-y-1">
                    <!-- Entries will be dynamically inserted here -->
                </ul>
            </div>
            <div id="archive-placeholder" class="card text-center py-8 text-gray-400">
                <p>Data not loaded. Please ensure credentials are correct and click 'Load Latest Data'.</p>
            </div>
        </div>

        <!-- Admin View -->
        <div id="view-admin" class="space-y-4 hidden">
            <div id="auth-check" class="card text-center py-8 bg-red-900 text-red-300">
                <p>Admin access required.</p>
            </div>
            <div id="admin-controls" class="hidden">
                <div class="card mb-4 space-y-4">
                    <h2 class="text-xl font-bold text-atlas-light">Create New Game Record</h2>
                    
                    <div class="flex space-x-4">
                        <div class="w-1/2">
                            <label for="adminDate" class="block text-sm font-medium text-gray-300 mb-1">Game Date</label>
                            <input type="date" id="adminDate" class="input-style" value="">
                        </div>
                        <div class="w-1/2">
                            <label for="adminStatus" class="block text-sm font-medium text-gray-300 mb-1">Game Status</label>
                            <select id="adminStatus" class="input-style">
                                <option value="COMPLETE">COMPLETE</option>
                                <option value="IN_PROGRESS">IN_PROGRESS</option>
                                <option value="PENDING">PENDING</option>
                            </select>
                        </div>
                    </div>
                    
                    <div>
                        <label for="adminEntries" class="block text-sm font-medium text-gray-300 mb-1">Game Entries (One per line, e.g., Tokyo (AG))</label>
                        <textarea id="adminEntries" class="input-style h-48 resize-none" placeholder="Tokyo (AG)&#10;Paris (DJ)&#10;..."></textarea>
                    </div>

                    <button class="btn-green w-full" onclick="parseAndSaveGame()">Parse and Automatically Save Game</button>
                </div>

                <div class="card">
                    <h2 class="text-xl font-bold text-atlas-light mb-3">Admin Login</h2>
                    <div class="space-y-4">
                        <input type="text" id="adminUsername" class="input-style" placeholder="Username">
                        <input type="password" id="adminPassword" class="input-style" placeholder="Password">
                        <button class="btn-blue w-full" onclick="adminLogin()">Login</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global State
        let ATLAS_ARCHIVE = [];
        let isAuthenticated = false;

        // =========================================================================
        // !!! PASTE YOUR VALIDATED CREDENTIALS HERE !!!
        // You should see these lines immediately after the "Global State" block.
        // =========================================================================
        const HARDCODED_URL = "https://api.jsonbin.io/v3/b/68f3dc64d0ea881f40aa8741"; 
        const HARDCODED_KEY = "$2a$10$zqLmCEPiBb8GMRjxY1ATEupOlfjxD1zAqFEeyC/ZZwuon0o0t1Ip2"; 
        // =========================================================================

        const ADMIN_USER = 'atlasadmin';
        const ADMIN_PASS = 'gamecorp';

        // --- Utility Functions ---

        function showNotification(message, type = 'success') {
            const area = document.getElementById('notification-area');
            const color = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-yellow-500';
            const notification = document.createElement('div');
            notification.className = `p-3 rounded-lg text-white font-semibold shadow-xl ${color} max-w-xs mx-auto transform transition duration-300`;
            notification.innerHTML = message;
            area.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.add('opacity-0');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // --- Admin/Authentication ---

        function adminLogin() {
            const user = document.getElementById('adminUsername').value;
            const pass = document.getElementById('adminPassword').value;

            if (user === ADMIN_USER && pass === ADMIN_PASS) {
                isAuthenticated = true;
                document.getElementById('auth-check').classList.add('hidden');
                document.getElementById('admin-controls').classList.remove('hidden');
                showNotification('Admin Logged In', 'success');
            } else {
                showNotification('Invalid Credentials', 'error');
            }
        }

        // --- API & Data Functions ---

        async function loadData(url, key) {
            document.getElementById('archive-placeholder').innerHTML = 'Loading data...';
            try {
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'X-Master-Key': key,
                        'X-Bin-Meta': 'false' // Ensure we get raw data
                    }
                });

                if (!response.ok) {
                    const errorDetails = `HTTP Error: ${response.status}. Check ID URL, Master Key, or if the Bin is Public.`;
                    throw new Error(errorDetails);
                }

                const data = await response.json();
                
                // Set global state and update UI
                ATLAS_ARCHIVE = Array.isArray(data) ? data : [];
                populateGameSelector();
                document.getElementById('archive-placeholder').classList.add('hidden');
                showNotification('Data Loaded Successfully', 'success');

            } catch (error) {
                console.error("Data Load Error:", error);
                document.getElementById('archive-placeholder').innerHTML = `
                    <p class="text-red-400">Error Connecting to JSONBin!</p>
                    <p class="text-sm mt-2">${error.message}</p>
                    <p class="text-xs mt-2">Ensure the URL (Bin ID), Master Key, and Bin Privacy are correct.</p>
                `;
                document.getElementById('archive-placeholder').classList.remove('hidden');
                ATLAS_ARCHIVE = [];
                populateGameSelector();
                showNotification('Data Load Failed', 'error');
            }
        }

        async function saveGameArchive(url, key) {
             try {
                // Ensure the data is saved as a JSON array
                const payload = JSON.stringify(ATLAS_ARCHIVE);

                const response = await fetch(url, {
                    method: 'PUT', // PUT overwrites the entire Bin
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': key,
                        'X-Bin-Meta': 'false'
                    },
                    body: payload
                });

                if (!response.ok) {
                    const errorDetails = `HTTP Save Error: ${response.status}. Failed to overwrite Bin.`;
                    throw new Error(errorDetails);
                }

                // Load the data back immediately to confirm and update UI
                await loadData(url, key);
                showNotification('Game Record Saved & Archive Updated!', 'success');

            } catch (error) {
                console.error("Data Save Error:", error);
                showNotification(`SAVE FAILED: ${error.message}`, 'error');
            }
        }

        function parseAndSaveGame() {
            if (!isAuthenticated) {
                showNotification('Must be logged into Admin Portal to save.', 'error');
                return;
            }

            const url = document.getElementById('binUrl').value || HARDCODED_URL;
            const key = document.getElementById('masterKey').value || HARDCODED_KEY;

            const date = document.getElementById('adminDate').value;
            const status = document.getElementById('adminStatus').value;
            const entriesText = document.getElementById('adminEntries').value;
            
            if (!date || !entriesText.trim()) {
                showNotification('Date and Entries cannot be blank.', 'error');
                return;
            }

            // 1. Parse Entries
            const newEntries = entriesText.split('\n')
                .map(line => line.trim())
                .filter(line => line.length > 0)
                .map((line, index) => {
                    // Attempt to parse (e.g., "City (Player)")
                    const match = line.match(/(.*?)\s*\(([^)]+)\)/);
                    if (match) {
                        return { entry: match[1].trim(), player: match[2].trim() };
                    } else {
                        // Fallback if format is not strict
                        return { entry: line, player: `Player ${index + 1}` };
                    }
                });

            // 2. Create New Game Object
            const newGame = {
                id: `${date}-${ATLAS_ARCHIVE.length + 1}`,
                date: date,
                status: status,
                entries: newEntries,
                savedAt: new Date().toISOString()
            };

            // 3. Check for existing game (e.g., same date) and replace or append
            const existingIndex = ATLAS_ARCHIVE.findIndex(game => game.date === date);

            if (existingIndex !== -1) {
                ATLAS_ARCHIVE[existingIndex] = newGame; // Replace old entry with new
                showNotification(`Replaced existing record for ${date}`, 'warning');
            } else {
                ATLAS_ARCHIVE.push(newGame); // Append new entry
            }

            // 4. Trigger Save to JSONBin
            saveGameArchive(url, key);
        }

        // --- UI Logic ---

        function setView(viewId) {
            document.getElementById('tab-archive').classList.remove('bg-atlas-light', 'text-atlas-dark');
            document.getElementById('tab-admin').classList.remove('bg-atlas-light', 'text-atlas-dark');

            document.getElementById('view-archive').classList.add('hidden');
            document.getElementById('view-admin').classList.add('hidden');

            document.getElementById(`tab-${viewId}`).classList.add('bg-atlas-light', 'text-atlas-dark');
            document.getElementById(`view-${viewId}`).classList.remove('hidden');
        }

        function populateGameSelector() {
            const selector = document.getElementById('gameSelector');
            selector.innerHTML = '<option value="">-- Select Game Date --</option>';

            // Sort by date (newest first)
            const sortedArchive = [...ATLAS_ARCHIVE].sort((a, b) => new Date(b.date) - new Date(a.date));

            sortedArchive.forEach(game => {
                const option = document.createElement('option');
                option.value = game.date;
                option.textContent = `${game.date} (${game.status})`;
                selector.appendChild(option);
            });

            // Clear details when populating
            document.getElementById('game-details').classList.add('hidden');
        }

        function displayGameDetails() {
            const selectedDate = document.getElementById('gameSelector').value;
            const detailsDiv = document.getElementById('game-details');
            const entriesList = document.getElementById('entries-list');

            if (!selectedDate) {
                detailsDiv.classList.add('hidden');
                return;
            }

            const game = ATLAS_ARCHIVE.find(g => g.date === selectedDate);
            if (!game) return;

            // Update details
            document.getElementById('detail-date').textContent = `Game Date: ${game.date}`;
            document.getElementById('detail-status').textContent = `Status: ${game.status}`;
            
            // Populate entries
            entriesList.innerHTML = '';
            game.entries.forEach(entry => {
                const li = document.createElement('li');
                li.className = 'text-gray-300 border-b border-gray-700 last:border-b-0 py-1 flex justify-between';
                li.innerHTML = `
                    <span class="font-medium text-atlas-light">${entry.entry}</span>
                    <span class="text-sm text-gray-400">Player: ${entry.player}</span>
                `;
                entriesList.appendChild(li);
            });

            detailsDiv.classList.remove('hidden');
        }
        
        function initManualLoad() {
            const url = document.getElementById('binUrl').value;
            const key = document.getElementById('masterKey').value;
            loadData(url, key);
        }

        // --- Initialization ---

        function initApp() {
            // Set today's date in admin form
            document.getElementById('adminDate').valueAsDate = new Date();

            const isConfigured = HARDCODED_URL.startsWith('https://') && HARDCODED_KEY.length > 10;
            
            if (isConfigured) {
                // Auto-load data if credentials are hardcoded
                loadData(HARDCODED_URL, HARDCODED_KEY);
                
                // Hide manual config fields since it's auto-configured
                document.getElementById('binUrl').value = HARDCODED_URL;
                document.getElementById('masterKey').value = HARDCODED_KEY;
                document.getElementById('config-panel').classList.add('hidden');
                document.getElementById('archive-placeholder').innerHTML = 'Loading data automatically...';

            } else {
                // Show configuration requirement if constants are placeholders
                document.getElementById('archive-placeholder').innerHTML = `
                    <p class="font-semibold text-yellow-400">Configuration required.</p>
                    <p class="text-sm mt-2">Please update the HARDCODED_URL and HARDCODED_KEY constants in the script block.</p>
                `;
            }

            setView('archive');
        }

        window.onload = initApp;
    </script>
</body>
</html>

